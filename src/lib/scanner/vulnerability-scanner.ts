/**
 * Vulnerability Scanning Module
 * Implements OWASP Top 10 checks and common vulnerability detection
 */

export interface Vulnerability {
  id: string;
  type: VulnerabilityType;
  severity: "critical" | "high" | "medium" | "low";
  title: string;
  description: string;
  cwe?: string;
  owaspCategory?: string;
  location?: string;
  evidence?: string;
  recommendation: string;
  riskScore: number; // 0-100
  detectedAt: Date;
}

export type VulnerabilityType =
  | "SQL_INJECTION"
  | "XSS"
  | "CSRF"
  | "FILE_INCLUSION"
  | "AUTH_BYPASS"
  | "INSECURE_DESERIALIZATION"
  | "XXE"
  | "SSRF"
  | "INSECURE_DIRECT_OBJECT_REFERENCE"
  | "SECURITY_MISCONFIGURATION"
  | "SENSITIVE_DATA_EXPOSURE"
  | "MISSING_FUNCTION_LEVEL_ACCESS_CONTROL"
  | "USING_COMPONENTS_WITH_KNOWN_VULNERABILITIES"
  | "INSUFFICIENT_LOGGING"
  | "WEAK_CRYPTOGRAPHY";

// OWASP Top 10 2021 Categories
export const OWASP_TOP_10 = {
  A01_BROKEN_ACCESS_CONTROL: "A01:2021 – Broken Access Control",
  A02_CRYPTOGRAPHIC_FAILURES: "A02:2021 – Cryptographic Failures",
  A03_INJECTION: "A03:2021 – Injection",
  A04_INSECURE_DESIGN: "A04:2021 – Insecure Design",
  A05_SECURITY_MISCONFIGURATION: "A05:2021 – Security Misconfiguration",
  A06_VULNERABLE_COMPONENTS: "A06:2021 – Vulnerable and Outdated Components",
  A07_AUTH_FAILURES: "A07:2021 – Identification and Authentication Failures",
  A08_SOFTWARE_DATA_INTEGRITY: "A08:2021 – Software and Data Integrity Failures",
  A09_SECURITY_LOGGING: "A09:2021 – Security Logging and Monitoring Failures",
  A10_SSRF: "A10:2021 – Server-Side Request Forgery (SSRF)",
};

// SQL Injection patterns
const SQL_INJECTION_PATTERNS = [
  /('|"|;|--|\/\*|\*\/|xp_|sp_|exec|execute|union|select|insert|update|delete|drop|create|alter|truncate)/gi,
  /(\bor\b|\band\b)\s+\d+\s*=\s*\d+/gi,
  /(\bor\b|\band\b)\s+['"]\w+['"]\s*=\s*['"]\w+['"]/gi,
  /(\bor\b|\band\b)\s+1\s*=\s*1/gi,
  /(\bor\b|\band\b)\s+1\s*=\s*0/gi,
];

// XSS patterns
const XSS_PATTERNS = [
  /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
  /javascript:/gi,
  /on\w+\s*=/gi,
  /<iframe/gi,
  /<img[^>]+src\s*=\s*["']?javascript:/gi,
  /<svg[^>]*onload/gi,
  /expression\s*\(/gi,
];

// File inclusion patterns
const FILE_INCLUSION_PATTERNS = [
  /\.\.\/|\.\.\\/g,
  /\/etc\/passwd/gi,
  /\/proc\/self\/environ/gi,
  /\/windows\/system32/gi,
  /include\s*\(|require\s*\(|include_once|require_once/gi,
];

// Authentication bypass patterns
const AUTH_BYPASS_PATTERNS = [
  /admin\s*=\s*true/gi,
  /isAdmin\s*=\s*true/gi,
  /role\s*=\s*["']admin["']/gi,
  /authenticated\s*=\s*true/gi,
  /bypass/gi,
  /skip.*auth/gi,
];

export class VulnerabilityScanner {
  /**
   * Scan URL for vulnerabilities
   */
  static async scanUrl(url: string, content?: string): Promise<Vulnerability[]> {
    const vulnerabilities: Vulnerability[] = [];
    const urlLower = url.toLowerCase();
    const contentLower = content?.toLowerCase() || "";

    // SQL Injection checks
    if (this.checkSQLInjection(url) || (content && this.checkSQLInjection(content))) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-1`,
        type: "SQL_INJECTION",
        severity: "critical",
        title: "Potential SQL Injection Vulnerability",
        description: "The input contains patterns commonly used in SQL injection attacks.",
        cwe: "CWE-89",
        owaspCategory: OWASP_TOP_10.A03_INJECTION,
        location: url,
        evidence: "SQL injection patterns detected in input",
        recommendation: "Use parameterized queries and input validation. Implement proper SQL escaping.",
        riskScore: 90,
        detectedAt: new Date(),
      });
    }

    // XSS checks
    if (this.checkXSS(url) || (content && this.checkXSS(content))) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-2`,
        type: "XSS",
        severity: "high",
        title: "Cross-Site Scripting (XSS) Vulnerability",
        description: "The input contains patterns that could lead to XSS attacks.",
        cwe: "CWE-79",
        owaspCategory: OWASP_TOP_10.A03_INJECTION,
        location: url,
        evidence: "XSS patterns detected in input",
        recommendation: "Implement proper output encoding and Content Security Policy (CSP). Validate and sanitize all user inputs.",
        riskScore: 85,
        detectedAt: new Date(),
      });
    }

    // File Inclusion checks
    if (this.checkFileInclusion(url) || (content && this.checkFileInclusion(content))) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-3`,
        type: "FILE_INCLUSION",
        severity: "high",
        title: "Local/Remote File Inclusion Vulnerability",
        description: "The input contains path traversal patterns that could lead to file inclusion attacks.",
        cwe: "CWE-22",
        owaspCategory: OWASP_TOP_10.A03_INJECTION,
        location: url,
        evidence: "Path traversal patterns detected",
        recommendation: "Validate and sanitize file paths. Use whitelist-based file access. Avoid user-controlled file paths.",
        riskScore: 80,
        detectedAt: new Date(),
      });
    }

    // Authentication bypass checks
    if (this.checkAuthBypass(url) || (content && this.checkAuthBypass(content))) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-4`,
        type: "AUTH_BYPASS",
        severity: "critical",
        title: "Authentication Bypass Vulnerability",
        description: "The input contains patterns that could bypass authentication mechanisms.",
        cwe: "CWE-287",
        owaspCategory: OWASP_TOP_10.A07_AUTH_FAILURES,
        location: url,
        evidence: "Authentication bypass patterns detected",
        recommendation: "Implement proper authentication checks. Use secure session management. Validate user permissions on every request.",
        riskScore: 95,
        detectedAt: new Date(),
      });
    }

    // Security misconfiguration checks
    if (this.checkSecurityMisconfiguration(url, content)) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-5`,
        type: "SECURITY_MISCONFIGURATION",
        severity: "medium",
        title: "Security Misconfiguration Detected",
        description: "The target shows signs of security misconfiguration (exposed debug info, default credentials, etc.).",
        cwe: "CWE-16",
        owaspCategory: OWASP_TOP_10.A05_SECURITY_MISCONFIGURATION,
        location: url,
        evidence: "Security misconfiguration indicators found",
        recommendation: "Review security configuration. Disable debug mode in production. Change default credentials. Implement security headers.",
        riskScore: 60,
        detectedAt: new Date(),
      });
    }

    // SSRF checks
    if (this.checkSSRF(url)) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-6`,
        type: "SSRF",
        severity: "high",
        title: "Server-Side Request Forgery (SSRF) Risk",
        description: "The URL structure suggests potential SSRF vulnerability.",
        cwe: "CWE-918",
        owaspCategory: OWASP_TOP_10.A10_SSRF,
        location: url,
        evidence: "SSRF risk indicators detected",
        recommendation: "Validate and sanitize URLs. Use whitelist for allowed domains. Implement network segmentation.",
        riskScore: 75,
        detectedAt: new Date(),
      });
    }

    return vulnerabilities;
  }

  /**
   * Scan API endpoint for vulnerabilities
   */
  static async scanApi(endpoint: string, method?: string, headers?: Record<string, string>): Promise<Vulnerability[]> {
    const vulnerabilities: Vulnerability[] = [];
    
    // Check for missing security headers
    if (!headers?.["X-Content-Type-Options"]) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-7`,
        type: "SECURITY_MISCONFIGURATION",
        severity: "medium",
        title: "Missing Security Headers",
        description: "The API endpoint is missing important security headers.",
        cwe: "CWE-693",
        owaspCategory: OWASP_TOP_10.A05_SECURITY_MISCONFIGURATION,
        location: endpoint,
        evidence: "Missing X-Content-Type-Options header",
        recommendation: "Implement security headers: X-Content-Type-Options, X-Frame-Options, Content-Security-Policy, Strict-Transport-Security.",
        riskScore: 50,
        detectedAt: new Date(),
      });
    }

    // Check for insecure HTTP
    if (endpoint.startsWith("http://")) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-8`,
        type: "SENSITIVE_DATA_EXPOSURE",
        severity: "high",
        title: "Insecure HTTP Protocol",
        description: "The API endpoint uses HTTP instead of HTTPS, exposing data to potential interception.",
        cwe: "CWE-319",
        owaspCategory: OWASP_TOP_10.A02_CRYPTOGRAPHIC_FAILURES,
        location: endpoint,
        evidence: "HTTP protocol detected (should use HTTPS)",
        recommendation: "Always use HTTPS for API endpoints. Implement TLS 1.2 or higher. Use certificate pinning for mobile apps.",
        riskScore: 70,
        detectedAt: new Date(),
      });
    }

    // Check for authentication issues
    if (!headers?.["Authorization"] && !endpoint.includes("public")) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-9`,
        type: "AUTH_BYPASS",
        severity: "high",
        title: "Missing Authentication",
        description: "The API endpoint appears to lack proper authentication mechanisms.",
        cwe: "CWE-306",
        owaspCategory: OWASP_TOP_10.A07_AUTH_FAILURES,
        location: endpoint,
        evidence: "No authorization header detected",
        recommendation: "Implement proper authentication (OAuth 2.0, JWT, API keys). Use rate limiting. Implement proper authorization checks.",
        riskScore: 80,
        detectedAt: new Date(),
      });
    }

    // Run URL-based checks
    const urlVulns = await this.scanUrl(endpoint);
    vulnerabilities.push(...urlVulns);

    return vulnerabilities;
  }

  /**
   * Scan file for vulnerabilities
   */
  static async scanFile(fileName: string, fileContent?: string): Promise<Vulnerability[]> {
    const vulnerabilities: Vulnerability[] = [];
    const content = fileContent?.toLowerCase() || "";
    const fileNameLower = fileName.toLowerCase();

    // Check for hardcoded secrets
    if (content) {
      const secretPatterns = [
        /password\s*=\s*["'][^"']+["']/gi,
        /api[_-]?key\s*=\s*["'][^"']+["']/gi,
        /secret\s*=\s*["'][^"']+["']/gi,
        /token\s*=\s*["'][^"']+["']/gi,
        /aws[_-]?access[_-]?key/gi,
        /private[_-]?key/gi,
      ];

      for (const pattern of secretPatterns) {
        if (pattern.test(content)) {
          vulnerabilities.push({
            id: `vuln-${Date.now()}-10`,
            type: "SENSITIVE_DATA_EXPOSURE",
            severity: "critical",
            title: "Hardcoded Secrets Detected",
            description: "The file contains hardcoded passwords, API keys, or other sensitive information.",
            cwe: "CWE-798",
            owaspCategory: OWASP_TOP_10.A02_CRYPTOGRAPHIC_FAILURES,
            location: fileName,
            evidence: "Hardcoded secrets pattern detected",
            recommendation: "Remove hardcoded secrets. Use environment variables or secure key management systems. Rotate exposed credentials immediately.",
            riskScore: 95,
            detectedAt: new Date(),
          });
          break;
        }
      }
    }

    // Check for SQL injection in code
    if (content && this.checkSQLInjection(content)) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-11`,
        type: "SQL_INJECTION",
        severity: "high",
        title: "Potential SQL Injection in Code",
        description: "The file contains code patterns that could lead to SQL injection vulnerabilities.",
        cwe: "CWE-89",
        owaspCategory: OWASP_TOP_10.A03_INJECTION,
        location: fileName,
        evidence: "SQL injection patterns in code",
        recommendation: "Use parameterized queries or prepared statements. Implement input validation and sanitization.",
        riskScore: 85,
        detectedAt: new Date(),
      });
    }

    // Check for XSS in code
    if (content && this.checkXSS(content)) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-12`,
        type: "XSS",
        severity: "medium",
        title: "Potential XSS Vulnerability in Code",
        description: "The file contains code patterns that could lead to XSS vulnerabilities.",
        cwe: "CWE-79",
        owaspCategory: OWASP_TOP_10.A03_INJECTION,
        location: fileName,
        evidence: "XSS patterns in code",
        recommendation: "Implement proper output encoding. Use Content Security Policy (CSP). Validate and sanitize all user inputs.",
        riskScore: 70,
        detectedAt: new Date(),
      });
    }

    // Check for insecure deserialization
    if (content && /deserialize|unserialize|pickle|yaml\.load/gi.test(content)) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-13`,
        type: "INSECURE_DESERIALIZATION",
        severity: "high",
        title: "Insecure Deserialization Detected",
        description: "The file contains insecure deserialization patterns.",
        cwe: "CWE-502",
        owaspCategory: OWASP_TOP_10.A08_SOFTWARE_DATA_INTEGRITY,
        location: fileName,
        evidence: "Deserialization functions detected",
        recommendation: "Avoid deserializing untrusted data. Use safe serialization formats. Implement integrity checks.",
        riskScore: 80,
        detectedAt: new Date(),
      });
    }

    // Check for weak cryptography
    if (content && /md5|sha1|des|rc4/gi.test(content)) {
      vulnerabilities.push({
        id: `vuln-${Date.now()}-14`,
        type: "WEAK_CRYPTOGRAPHY",
        severity: "medium",
        title: "Weak Cryptography Detected",
        description: "The file uses weak cryptographic algorithms.",
        cwe: "CWE-327",
        owaspCategory: OWASP_TOP_10.A02_CRYPTOGRAPHIC_FAILURES,
        location: fileName,
        evidence: "Weak cryptographic algorithms detected (MD5, SHA1, DES, RC4)",
        recommendation: "Use strong cryptographic algorithms (SHA-256, AES-256, RSA-2048+). Avoid deprecated algorithms.",
        riskScore: 65,
        detectedAt: new Date(),
      });
    }

    return vulnerabilities;
  }

  // Helper methods for pattern checking
  private static checkSQLInjection(input: string): boolean {
    return SQL_INJECTION_PATTERNS.some((pattern) => pattern.test(input));
  }

  private static checkXSS(input: string): boolean {
    return XSS_PATTERNS.some((pattern) => pattern.test(input));
  }

  private static checkFileInclusion(input: string): boolean {
    return FILE_INCLUSION_PATTERNS.some((pattern) => pattern.test(input));
  }

  private static checkAuthBypass(input: string): boolean {
    return AUTH_BYPASS_PATTERNS.some((pattern) => pattern.test(input));
  }

  private static checkSecurityMisconfiguration(url: string, content?: string): boolean {
    const indicators = [
      /debug\s*=\s*true/gi,
      /error.*display/gi,
      /stack.*trace/gi,
      /\.git/gi,
      /\.env/gi,
      /phpinfo/gi,
    ];
    return indicators.some((pattern) => pattern.test(url) || (content && pattern.test(content)));
  }

  private static checkSSRF(url: string): boolean {
    const ssrfIndicators = [
      /localhost|127\.0\.0\.1|0\.0\.0\.0/gi,
      /internal|private|192\.168/gi,
      /file:\/\/|gopher:\/\/|dict:\/\//gi,
    ];
    return ssrfIndicators.some((pattern) => pattern.test(url));
  }

  /**
   * Calculate overall risk score from vulnerabilities
   */
  static calculateRiskScore(vulnerabilities: Vulnerability[]): number {
    if (vulnerabilities.length === 0) return 0;

    const weights = { critical: 4, high: 3, medium: 2, low: 1 };
    let totalWeight = 0;
    let totalScore = 0;

    vulnerabilities.forEach((vuln) => {
      const weight = weights[vuln.severity] || 1;
      totalWeight += weight;
      totalScore += vuln.riskScore * weight;
    });

    return Math.min(100, Math.round(totalScore / totalWeight));
  }

  /**
   * Get severity distribution
   */
  static getSeverityDistribution(vulnerabilities: Vulnerability[]) {
    return {
      critical: vulnerabilities.filter((v) => v.severity === "critical").length,
      high: vulnerabilities.filter((v) => v.severity === "high").length,
      medium: vulnerabilities.filter((v) => v.severity === "medium").length,
      low: vulnerabilities.filter((v) => v.severity === "low").length,
    };
  }
}

